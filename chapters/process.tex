\chapter{Graph Processes}

\section{Motivation}

Why do we use it to generate tests?

To a more in depth-explanation, see~\cite{Ribeiro1996, Corradini2014} 

\section{Doubly-Typed Graph Grammars}

\begin{definition}[Doubly-Typed Graph] Given a type graph $T$, a \emph{doubly-typed graph} \doublyTypedGraph{} over $T$ is a tuple \doublyTypedGraph $= \left(G^T, t^{G^T},TG^T\right)$ where $G^T$ and $TG^T$ are typed graphs over $T$ and \mbox{$t^{G^T} : G^T \rightarrow TG^T$} is a typed graph morphism in \typedGraphCategory{}. We call $TG^T$ the \emph{double-type graph} and $t^{G^T}$ the double-typing morphism.

\end{definition}

\begin{definition}[Doubly-Typed Graph Morphisms]
  Given two doubly-typed graphs $G^{TG^T}$ and $H^{TG^T}$ and a graph morphism $g^T : G^T \rightarrow H^T$, we say that $g^T$ is a \emph{$TG^T$-doubly-typed graph morphism} if the following diagram commutes:

\diagram{
  G\ar[rr]^{g}\ar[d]_{t^{G}}& & H\ar[d]^{t^{H}} \\
  TG\ar[rr]^{id}\ar[dr]_{type_{TG}} & &TG\ar[dl]^{type_{TG}} \\
  & T &
}
\end{definition}

Notice that the type morphisms $type_G : G \rightarrow T$ and $type_H : H \rightarrow T$ can be obtained respectively as $type_{TG} \circ t^G$ and $type_{TG} \circ t^H$.

\begin{remark} Although there are different kinds of doubly-typed graph morphisms depending on whether the doubly-type graphs and the type graphs are the different, we are here only interested in the case where the doubly-typed graphs share the same double-type and type graphs. Therefore we will call \mbox{\emph{$TG^T$-doubly-typed graph morphisms}} simply by \emph{doubly-typed graph morphisms} through the rest of this work.

\end{remark}

\begin{definition}[Doubly-Typed Graph Grammars] A \emph{doubly-typed graph grammar} is a tuple $GG = \left(TG^T, I^{TG^T},P \right)$ where $TG^T$ is the double-type graph of the grammar, $I^{TG^T}$ is a doubly-typed graph corresponding to the \emph{initial graph} of the grammar and $P$ is a set of doubly-typed graph rules. 
\end{definition}

\begin{definition}[Doubly-Typed Graph Rule] Given a double-type graph $TG^T$, a doubly-typed rule with respect to $TG^T$ is a span of morphisms \doublyTypedRule{} in \doublyTypedGraphCategory{} iff $p$ is a rule in \typedGraphCategory{} (see Definition~\ref{def:graph-rule})\tinytodo{$p$ or $p^T$?}. Also, given a doubly-typed graph rule \doublyTypedRule{} its inverse rule is defined by \inverseDoublyTypedRule{}.

  Let the typing morphisms from $L^{TG^T}$, $K^{TG^T}$ and $R^{TG^T}$ be $t^{L^T}$, $t^{K^T}$ and $t^{R^T}$, respectively. For a rule $a = p^{TG^T}$ we call:

  \begin{itemize}
    \item $L_a = L_T$, $K_a = K_R$ and $R_a = R_T$, the left, gluing and right graphs of $a$.
    \item $pre_a = t^{L^T} : L^T \rightarrow TG^T$, the \emph{pre-condition} of the $a$.
    \item $post_a = t^{R^T} : R^T \rightarrow TG^T$, the \emph{post-condition} of $a$.
    %\item $r_a = r^T$, the \emph{rule pattern} of $a$.\tinytodo{Not sure if we will need the rule pattern.}
  \end{itemize}
\end{definition}

\begin{definition}[Core Graph] Given a doubly-typed graph grammar \doublyTypedGraphGrammarCore{}, we have that \coreGraph{} is a \emph{core graph} iff $\forall x \in$ \coreGraph $: \exists! y \in \parens{I^T \uplus \parens{\uplus_{ai \in P} R_{ai}}}$\tinytodo{review this} such that

  \[ x =
    \begin{cases}
      in_{GG}\parens{y} & y \in I^T\\
      post_{ai}\parens{y} & y \in R_{ai} \land y \not\in rng\parens{r_{ai}}\\
    \end{cases}
   \]\tinytodo{reformulate this entire definition}

  \begin{intuition} The idea is that each element in the \emph{Core Graph} has a unique origin either being present in the initial graph or being created by a single rule.
\end{intuition}

  Each rule in a doubly-typed graph grammar whose double-type is also a core graph is called an \emph{action}. An action $a$ \emph{creates} an element $e$ iff $e \in R(a) - K(a)$. Similarly, an action $a$ \emph{deletes} an element $e$ iff $e \in L(a) - K(a)$.

\end{definition}

\section{Relations within Graph Grammars typed over a Core Graph}


As a core graph contains the entire ``execution history'' of a grammar, some interesting properties can be found by looking at it. Particularly, the relations between actions, elements, and actions and elements.

\begin{remark}[Different Graph Transformation interpretation] When dealing with actions, we will use a slightly different interpretation of the graph transformations. Given an action \emph{a}, we have that:
  
\diagram{
  L\ar[d]_{pre_a}        & & K\ar[ll]_{l}\ar[rr]^{r}\ar[d]|{k} & & R\ar[d]^{post_a}\\
  C^T_{|L}\ar@{}[urr]|{\left(1\right)} & & C^T_{|K}\ar[ll]^{f}\ar[rr]_{g}             & & C^T_{|R}\ar@{}[ull]|{\left(2\right)}
}
\hfill %\break

The first difference is that elements created or deleted by the underlying rule of an action are not merely typed over the core graph, but in fact exactly the ones in the core graph. Second, the elements in $pre_a - k_a$ and $post_a - k_a$ are not really deleted nor created, they must be always be present in the core graph as it maintains the history of execution. Nonetheless, their creation (resp. deletion) would be performed in an execution of the simply-typed grammar. Here, for the sake of
  simplicity, we overload these terms and continue to refer to this elements as deleted/created.

  Also, for practical purposes, we restrict the codomain of the pre-, post- and gluing morphisms of an action to their respective images, such as $pre_a : L \rightarrow C^T_{|L}$. This point will be returned later on when dealing with negative application conditions\tinytodo{Do not forget to explain this in the proper session}.
\end{remark}

In~\cite{Ribeiro1996}, the causal and conflict relations for doubly-typed graph grammars over a core graph were defined. There, the graph transformation approach used was the \emph{Single Pushout} (SPO) without NACs. \cite{Corradini1996} also defined a similar notion of causal relation with respect to the DPO approach without NACs. Here we recall these definitions and extend them to create a equivalent notion that works for grammars in DPO approach with NACs.

It is important to recall that the relationships extracted from a core graph whose underlying rules do not have NACs are always concrete, in the sense that if a rule is dependent on another one it is because the first one creates (some of) the elements necessary for the second to applied.

On the other hand, the potential dependencies and conflicts induced by NACs may not be real, for example: let $a_1, a_2, a_3$ be three actions of the same doubly-typed grammar. Suppose that $a_1$ creates elements used by $a_2$ and $a_2$ creates elements used by $a_3$. 
Now suppose that when $a_2$ is applied, it creates an element that would be forbidden by a NAC $a_1$ and also that $a_3$ deletes this element. By the classical notions of dependencies and conflicts with NACs, $a_2$ would conflict with $a_1$ and $a_1$ would be dependent on $a_3$, still this relationships can not occur in any execution of this grammar, once there is only one order (by creation and deletion of the elements) in which this rules can be applied, that is
$a_1,a_2,a_3$\tinytodo{This two paragraphs need a reformulation and an example}.

The dependency relations defined below are based on the following intuition:

\begin{intuition} An action $a_1$ is a direct cause of an action $a_2$ if either $a_1$ creates some element that is needed by $a_2$ or $a_1$ deletes an element that is both forbidden by a NAC of $a_2$ and existent before the application of $a_2$. In both cases, we have that $a_2$ can only happen after $a_1$.\footnote{Notice that we do not use the notion of irreversible dependency, as we are interested only in the ordered execution of the actions.} 
\end{intuition}

\begin{definition}[Unconditional Causal Dependency Relation] Given \doublyTypedGraphGrammarCore{} a doubly-typed graph grammar and \coreGraph{} a core graph. Let $a_1, a_2 \in P, a_1 \ne a_2$ and \mbox{$e_1, e_2 \in $ \coreGraph{},} $e_1 \ne e_2$. Then: 

  \begin{enumerate}
    \item The action $a_2$ is \emph{directly causally dependent} on $a_1$, written $a_1 < a_2$, iff \mbox{$\not\exists h_{21} : L_2 \rightarrow C^T_{|K_1}$ s.t. \mbox{$d_1 \circ h_{21} = pre_2$}}, where the two squares are pushouts and $C^T_{|R_1L_2}$ satisfies the NACs of $a_2$ if there is any.

  \diagram{
        L_1 & K_1\ar[d]\ar[l]\ar[r] & R_1\ar[dr]_{post_1} & & L_2\ar@{.>}@/_1.1pc/[dlll]|{|}_<<<<{h_{21}}\ar[dl]^{pre_2} & K_2\ar[l]\ar[r]\ar[d] & R_2\\
       & C^T_{K_1}\ar[rr]_{d_1} & & C^T_{|R_1L_2} & & C^T_{|K_2}\ar[ll] &}
   \item The \emph{causal dependency relation between actions} $(P, \leq)$ is the reflexive and transitive closure of the direct causal dependency.
     \item The element $e_2$ is \emph{directly causally dependent} on $e_1$ iff there is an action $a_1 \in P$ such that $a_1$ deletes $e_1$ and creates $e_2$.
    \item The \emph{causal dependency relation between elements} $(E, \leq)$ is the reflexive and transitive closure of the direct causal dependency.
  \end{enumerate}

  Also, we will need a \emph{causal dependency relation between elements and actions} and we will use here de notion defined by~\cite{Corradini1996}:

  \begin{enumerate}\addtocounter{enumi}{4}
    \item The action $a_1$ is \emph{directly causally dependent} on element $e_1$, written $e_1 < a_1$, iff $a_1$ deletes $e_1$. 
    \item The element $e_1$ is \emph{directly causally dependent} on action $a_1$, written $a_1 < e_1$, iff $a_1$ creates $e_1$.
    \item The causal dependency relation between actions and elements $(N, \leq)$ is the reflexive and transitive closure of the direct causal dependencies between action and element, element and action.
    \item The concrete causal dependency relation $(D, \leq)$ is the given by \mbox{$(P, \leq) \cup (E, \leq) \cup (N, \leq)$}\tinytodo{Or by the reflexive and transitive closure of this?}.
  \end{enumerate}
\end{definition}


As for the conflicts, the relations defined below are based on the following intuition: 

\begin{intuition} An action $a_1$ is in weak conflict with an action $a_2$ if either $a_1$ deletes something that is needed by $a_2$ to be applied or creates something that is forbidden by a NAC of $a_2$. In both cases, we have that $a_2$ can not happen once $a_1$ has happened, in other words $a_2$ can only happen before $a_1$.
\end{intuition}


\begin{definition}[Unconditional Weak Conflict Relation] Given \doublyTypedGraphGrammarCore{} a doubly-typed graph grammar and \coreGraph{} a core graph. Let $a_1, a_2 \in P, a_1 \ne a_2$ and \mbox{$e_1, e_2 \in $ \coreGraph{},} $e_1 \ne e_2$. Then: 

  \begin{enumerate}
    \item The action $a_2$ is \emph{direct weak conflict} with $a_1$ iff $\not\exists h_{12} : L_1 \rightarrow D_2$ s.t. \mbox{$d_2 \circ h_{12} = pre_1$}.

      \diagram{
        R_1 & K_1\ar[l]\ar[r]\ar[d] & L_1\ar[dr]_{pre_1} & & L_2\ar[dl]^{pre_2}\ar@{.>}@/_1.1pc/[dlll]|{|}_<<<<{h^{21}} & K_2\ar[l]\ar[r]\ar[d] & R_2\\
       & D_1\ar[rr]_{d_1} & & C^T & & D_2\ar[ll] &}
   \item The elements $e_1$ and $e_2$ are in directly weak conflict iff \tinytodo{complete}
    \item \emph{conflict relation}\tinytodo{complete}
  \end{enumerate}
\end{definition}

\begin{definition}[Concrete Occurence Relation] The union of unconditional dependency and conflict relations, i.e. produce-use and use-delete only.
\end{definition}

The problem with conditional relations in the core graph\tinytodo{expand}\tinytodo{define and explain the notion of incremental negative application conditions~\cite{Corradini2013}}

\begin{definition}[Sketch] Given \doublyTypedGraphGrammarCore{} a doubly-typed graph grammar, \coreGraph{} a core graph and $P$ a set of rules with incremental, non-trivially triggered NACs only.

Given $a_1, a_2 \in P$, when the dependency of the type delete-forbid or a conflict of the type produce-forbid are real?

Let $a_1$ delete from graph \coreGraph{} an element $x \in N($\coreGraph$) \cup E($\coreGraph$)$ that potentially triggers a NAC $N_2$ of $a_2$. There are three possible cases to look at:

\begin{enumerate}
  \item $a_2$ is somehow related to $x$ by the concrete occurence relation.
  \item $a_2$ is not related to $x$ by the concrete occurence relation, but $x$ is present in the initial graph.
  \item $a_2$ is not related to $x$ by the concrete occurence relation and $x$ is not present in the initial graph.
\end{enumerate}

First, let $x$ be related to $a_2$ by the concrete occurrence relation, i.e. \mbox{$x \leq a_2 \lor a_2 \leq x$}. If $a_2 \leq x$ it means that $x$ was either created by $a_2$ or by another action that has to occur after it. Thus, the delete-forbid dependency in this case can not be concrete as $x$ did not exist to trigger $N_2$ before $a_2$ was applied. On the other hand, if $x \leq a_2$, then $x$ must exists and must be deleted before $a_2$ is applied, therefore the rules are dependent by delete-forbid.

  Second, let $x$ be not related to $a_2$ and also not created by any rule in $P$, i.e., $x \in I^{C^T}$. Then, the rules are in delete-forbid, because $x$ existed before $a_2$, which can not be applied until $x$ is deleted.

  Third, $x$ is not related to $a_2$, but there is a third rule $a_3 \in P$ which creates it, (notice that, $a_3 < a_1$ by produce-use), and $a_3$ is not related to $a_2$ by the concrete occurrence relation\footnote{If $a_3$ is related to $a_2$ and $a_3$ creates $x$, then $a_2$ is related to $x$, which corresponds to the first case.}
. In this case, we may have that $a_1 < a_2$ by delete-forbid if we choose a configuration where $a_3$ is applied before $a_2$.\end{definition}

\begin{definition}[Conditional Causal Dependency Relation] Given two

\diagram{
   & & & & N_2 & &\\
  L_1\ar[d] & K_1\ar[d]\ar[l]\ar[r] & R_1\ar[dr]_{post_1} & & L_2\ar[u]_n\ar@{.>}@/_1.1pc/[dlll]_<<<<{h_{21}}\ar[dl]^{pre_2} & K_2\ar[l]\ar[r]\ar[d] & R_2\\
     C^T_{|L_1} & C^T_{|K_1}\ar[rr]_{d_1}\ar[l]^{e_1} & & C^T_{|R_1L_2} & & C^T_{|K_2}\ar[ll] &}

\end{definition}

\begin{definition}[Conditional Weak Conflict Relation]
\end{definition}

\begin{definition}[Occurrence Relation]
\end{definition}

\begin{definition}[Occurrence Graph Grammars]
\end{definition}

\begin{definition}[Concurrent Graphs]
\end{definition}

\section{Calculating Graph Process}

\subsection{Graph Process without NACs}

\begin{definition}[Colimit construction]
\end{definition}

\subsection{Graph Process with NACs}

\begin{definition}[Incremental NACs]
\end{definition}

\begin{definition}[Colimit construction with Incremental NACs]
\end{definition}
